(()=>{let e=0,t=[];function o(e){return new Promise(t=>{chrome.storage.local.get(e,t)})}function n(){const e=setInterval(()=>{clearInterval(e),n(),a()},1e3)}function i(e){const t=/[?:;"<>/\\|*]|^\s+|[\u200B-\u200D\uFEFF]/gi;return e.replace(t,e=>e===" "||e.match(/[\u200B-\u200D\uFEFF]/)?"":"_")}function d(e){return btoa(e)}function a(){const e=document.querySelectorAll(".d-track, .track");if(e)for(let t in e)e[t].tagName=="DIV"&&r(e[t])}function r(n){let i=n.classList;if(i.contains("_music_ready")||!n)return null;i.add("_music_ready");let o=n.querySelectorAll(".d-track__title, .d-link.track__title")[0];if(o){let i=document.createElement("span");i.href="#",i.title="Скачать",i.classList.add("_music_save"),i.innerHTML=`<button class="button button_round button_action button-play button-play__type_track button_ico" id="_music_save_button" style="background-image: url(${chrome.runtime.getURL("images/save_button.png")})"></button>`,o.parentElement.insertBefore(i,o);let a=document.querySelectorAll(".page-main__chart.column-chart, .page-metatag__tracks, .sidebar__tracks, .page-artist__tracks_top, .serp-snippet__tracks, .serp-snippet__podcast_episodes");a.length==0&&(a=[i.parentElement.parentElement.parentElement.parentElement.parentElement.parentElement]),chrome.runtime.sendMessage({message:"all"},e=>{a&&e==!0&&[...a].forEach(e=>{let t=e.querySelectorAll("._music_save")||[];t.length>1&&c(e)})}),i.addEventListener("click",function(o){if(this.alreadyCalled&&i?.innerText!="error")return!0;this.alreadyCalled=!0,o.stopPropagation(),o.preventDefault(),chrome.runtime.sendMessage({message:"check"},o=>{if(o.status==!0){i.innerHTML='<button class="button button_round button_action button-play button-play__type_track button_ico" id="_music_save_button" style="background-color: #ff3333">error</button>';return}i.innerHTML='<button class="button button_round button_action button-play button-play__type_track button_ico" id="_music_save_button">0%</button>';let a;try{a=n.getElementsByClassName("d-track__play")[0].getElementsByTagName("button")[0].getAttribute("data-idx")}catch{a=n.querySelector(".d-link.deco-link.track__title").getAttribute("href").split("/")[4]}let r=0;try{r=n.querySelectorAll(".d-track__chart-number, .d-track__id")[0].innerText}catch{}if(!a)return;if(e++,e>7){t.push([i,a,r]);return}s(i,a,r)})})}}function s(n,a,r){function c(e,t){let s=0;return new Promise((o,i)=>{function a(){e.read().then(({done:e,value:i})=>{if(e){o();return}s=s+i.byteLength;try{n.innerHTML=`<button class="button button_round button_action button-play button-play__type_track button_ico" id="_music_save_button">${Math.round(s/Number(t)*100)}%</button>`}catch(e){console.log(e)}a()}).catch(i)}a()})}let d=`https://${location.host}/handlers/track.jsx?track=${a}`;fetch(d).then(e=>e.json()).catch(e=>{}).then(a=>{let d=a.track,u=`https://${location.host}/api/v2.1/handlers/track/${d.id}/track/download/m?hq=1`;fetch(u,{headers:{Accept:"application/json; q=1.0, text/*; q=0.8, */*; q=0.1","X-Requested-With":"XMLHttpRequest","X-Retpath-Y":encodeURIComponent(location.href)}}).then(e=>e.json()).then(a=>{if(!a.src){n.innerHTML=`<button class="button button_round button_action button-play button-play__type_track button_ico" id="_music_save_button" style="background-color: #ff3333">error</button>`;return}fetch(`${a.src}&format=json`).then(e=>e.json()).catch(t=>{e--,n.innerHTML=`<button class="button button_round button_action button-play button-play__type_track button_ico" id="_music_save_button" style="background-color: #ff3333">error</button>`}).then(async a=>{if(!a.s)return;let m=["XGRlBW9FXlekgbPrRHuSiA",a.path.substr(1),a.s],h="",p=[],g,f="",v="",b,j="";if(m=m.join(""),m=window.Crypto.MD5(m),g=encodeURIComponent(`https://${a.host}/get-mp3/${m}/${a.ts}${a.path}`),d.title&&(f=d.title),d.artists[1]){for(let e in d.artists)h+=d.artists[e].name+",",p.push(d.artists[e].name);h=h.substring(0,h.length-1)}else d.artists[0]?(p.push(d.artists[0].name),h=d.artists[0].name):h=d.title;if(d.version&&(f=f+` (${d.version})`),h=i(`${h} - ${f}.mp3`),d.albums[0]){v=d.albums[0].title||"",j=d.albums[0].year||"";try{genre=d.albums[0].genre||d.albums[0].genre[0]}catch{genre=""}try{number=d.albums[0].trackPosition.index}catch{number=""}}const u=await o(["tags","folder","path","position","cover"]);if(d.coverUri){let e="400x400";u.cover&&(e=u.cover);const t=d.coverUri.replace("%%",e);b=encodeURIComponent(`https://${t}`)}const y={message:"data",url:g,name:h,artist:p,title:f,album:v,cover:b,year:j,genre,number,position:r};if(y.message=="data"){_(y);function _(o){Promise.all([fetch(decodeURIComponent(o.url)).then(e=>(c(e.clone().body.getReader(),e.headers.get("content-length")),e.arrayBuffer())),fetch(decodeURIComponent(o.cover)).then(e=>e.arrayBuffer())]).then(i=>{const r=new browserId3Writer(i[0]);r.setFrame("TIT2",o.title).setFrame("TPE1",o.artist).setFrame("TPE2",o.artist).setFrame("TALB",o.album).setFrame("TYER",o.year).setFrame("TCON",[o.genre]).setFrame("TRCK",o.number);try{r.setFrame("APIC",{type:3,data:i[1],description:""})}catch{}u.tags==!0&&r.addTag();let a;u.folder==!0&&u.path.length>0?u.position==!0?o.position>0?a=`${u.path}/${o.position}. ${o.name}`:a=`${u.path}/${o.number}. ${o.name}`:a=`${u.path}/${o.name}`:u.position==!0?o.position>0?a=`${o.position}. ${o.name}`:a=`${o.number}. ${o.name}`:a=o.name;const c=r.getURL();chrome.runtime.sendMessage({message:"download",url:c,filename:a},o=>{if(o.status=="done"&&(n.innerHTML=`<button class="button button_round button_action button-play button-play__type_track button_ico" id="_music_save_button" style="background-color: #0cf40c">100%</button>`,e--,console.log(`%cQueue: ${e}     Array: ${t.length}`,"border-radius: 2px; padding: 2px 4px; color: #fff; background-color: purple"),e==0&&t.length==0&&l(),r.revokeURL(),t.length>0)){const e=t.shift();s(e[0],e[1],e[2])}})}).catch(e=>{console.log(e)})}}})}).catch(e=>null)}).catch(e=>null)}function c(e){let t=document.createElement("span"),n=e.querySelector("._music_download_all_container");n||(t.className="_music_download_all_btn",t.title="Нажми, чтобы скачать все аудиозаписи. Максимальное кол-во скачиваний ограничивается 100 треками.",t.innerHTML="Скачать все аудиозаписи (max = 100)",n=document.createElement("div"),n.className="_music_download_all_container",n.appendChild(t));function o(n){let s=e.querySelectorAll(n);t.innerHTML=`Загрузка ${s.length} треков началась...<br> * Загрузка будет завершена автоматически *`,t.title="Ожидайте окончания загрузки всех треков (max = 100)";for(let e=0;e<s.length;e++){let t=s.item(e);t.click()}}t.removeEventListener("click",s,!1),t.addEventListener("click",s,!1);function s(){o("#_music_save_button")}e.insertBefore(n,e.nextSibling)}function l(){document.querySelectorAll("._music_download_all_btn").forEach(e=>{e.innerText.includes("*")&&(e.style.color="#0cf40c",e.innerText="Загрузка завершена")})}n()})()